{% extends "base.html" %}

{% block title %}Meu Carrinho - {{ store_settings.store_name }}{% endblock %}

{% block content %}
<div class="cart-container">
    <h1 class="cart-title">
        <i class="fa fa-shopping-cart"></i> Meu Carrinho
    </h1>

    {% if cart_items %}
    <div class="cart-items-wrapper">
        {% for item in cart_items %}
        <div class="cart-item">
            <div class="cart-item__image-wrapper">
                {% if item.product.image_url %}
                <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" class="cart-item__image">
                {% else %}
                <i class="fa fa-cutlery cart-item__image-placeholder"></i>
                {% endif %}
            </div>
            
            <div class="cart-item__details">
                <div class="cart-item__name">{{ item.product.name }}</div>
                <div class="cart-item__code">Cód: {{ item.product.code }}</div>
                
                {% if item.extras %}
                <div class="cart-item__extras">
                    <div class="cart-item__extras-title">
                        <i class="fa fa-plus-circle"></i> Adicionais:
                    </div>
                    {% for cart_extra in item.extras %}
                    <div class="cart-item__extra-item">
                        <span class="cart-item__extra-name">
                            <i class="fa fa-check" style="color: #28a745; font-size: 10px;"></i>
                            {{ cart_extra.quantity }}x {{ cart_extra.extra.name }}
                        </span>
                        <span class="cart-item__extra-price">
                            + R$ {{ "%.2f"|format(cart_extra.extra.price * cart_extra.quantity) }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <div class="cart-item__price" data-label="Preço">
                <div class="cart-item__price-main">
                    R$ {{ "%.2f"|format(item.product.price) }}
                </div>
                {% if item.extras %}
                {% set extras_total = namespace(value=0) %}
                {% for extra in item.extras %}
                    {% set extras_total.value = extras_total.value + (extra.extra.price * extra.quantity) %}
                {% endfor %}
                <div class="cart-item__price-extras">
                    + R$ {{ "%.2f"|format(extras_total.value) }}
                </div>
                {% endif %}
            </div>
            
            <div class="cart-item__quantity" data-label="Quantidade">
                {{ item.quantity }}
            </div>
            
            <div class="cart-item__subtotal" data-label="Subtotal">
                {% set item_extras_total = namespace(value=0) %}
                {% for extra in item.extras %}
                    {% set item_extras_total.value = item_extras_total.value + (extra.extra.price * extra.quantity) %}
                {% endfor %}
                <div class="cart-item__subtotal-amount">
                    R$ {{ "%.2f"|format((item.product.price + item_extras_total.value) * item.quantity) }}
                </div>
            </div>
            
            <div class="cart-item__actions">
                <a href="{{ url_for('cart.remove_from_cart', item_id=item.id) }}" class="btn-outline-danger">
                    <i class="fa fa-trash"></i> Remover
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="summary-box">
        <div class="summary-box__inner">
            <div class="cart-summary">
                <h2 class="cart-summary__title">Resumo do Pedido</h2>
                
                <div class="cart-summary__row">
                    <span class="cart-summary__label">Subtotal:</span>
                    <span class="cart-summary__value">R$ {{ "%.2f"|format(subtotal) }}</span>
                </div>
                
                {% if coupon %}
                <div class="cart-summary__row">
                    <span class="cart-summary__label">Desconto ({{ coupon.code }}):</span>
                    <span class="cart-summary__value" style="color: var(--color-green);">
                        - R$ {{ "%.2f"|format(discount) }}
                    </span>
                </div>
                {% endif %}
                
                <div class="cart-summary__row cart-summary__total">
                    <span class="cart-summary__label">TOTAL:</span>
                    <span class="cart-summary__value">R$ {{ "%.2f"|format(total) }}</span>
                </div>
                
                <div class="pix-discount-banner">
                    <i class="fa fa-money"></i>
                    <strong>R$ {{ "%.2f"|format(total * 0.95) }}</strong> no PIX (5% de desconto)
                </div>

                <form method="POST" action="{{ url_for('cart.checkout') }}" id="checkoutForm">
                    <div class="form-section">
                        <h3 class="form-section__title">
                            <i class="fa fa-truck" style="color: var(--color-red);"></i> Tipo de Entrega
                        </h3>

                        {% if pickup_enabled %}
                        <label class="delivery-option">
                            <input type="radio" name="delivery_type" value="pickup" onchange="toggleDeliveryFields()" required>
                            <div class="delivery-option__content">
                                <strong class="delivery-option__title">
                                    <i class="fa fa-map-marker" style="color: var(--color-red);"></i>
                                    Retirada no Local
                                </strong>
                                <div class="delivery-option__description">
                                    {{ pickup_address }}
                                </div>
                                <span class="badge badge-success">
                                    <i class="fa fa-check-circle"></i> Sem custo de frete
                                </span>
                            </div>
                        </label>
                        {% endif %}

                        {% if delivery_enabled %}
                        <label class="delivery-option">
                            <input type="radio" name="delivery_type" value="delivery" {% if not pickup_enabled %}checked{% endif %} onchange="toggleDeliveryFields()" required>
                            <div class="delivery-option__content">
                                <strong class="delivery-option__title">
                                    <i class="fa fa-truck" style="color: var(--color-red);"></i>
                                    Entrega em Domicílio
                                </strong>
                                <div class="delivery-option__description">
                                    {% if total >= free_shipping_min %}
                                    <span class="badge badge-success">
                                        <i class="fa fa-check-circle"></i> FRETE GRÁTIS!
                                    </span>
                                    {% else %}
                                    Valor do frete: <strong>R$ {{ "%.2f"|format(shipping_cost) }}</strong>
                                    <div class="text-muted">
                                        <i class="fa fa-info-circle"></i> Frete grátis acima de R$ {{ "%.2f"|format(free_shipping_min) }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </label>
                        {% endif %}
                    </div>

                    <div class="form-section">
                        <h3 class="form-section__title">
                            <i class="fa fa-user" style="color: var(--color-red);"></i> Dados para Entrega
                        </h3>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-user-circle"></i> Nome Completo *
                            </label>
                            <input type="text" name="customer_name" required placeholder="Digite seu nome completo" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-phone"></i> Telefone *
                            </label>
                            <input type="tel" name="customer_phone" required placeholder="(11) 99999-9999" class="form-input">
                        </div>

                        <div id="delivery_address_field" class="form-group" style="display: none;">
                            <label class="form-label">
                                <i class="fa fa-map-marker"></i> Endereço Completo para Entrega *
                            </label>
                            <textarea name="delivery_address" rows="4" placeholder="Rua, número, complemento, bairro, cidade, estado, CEP" class="form-textarea"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-comment"></i> Observações (Opcional)
                            </label>
                            <textarea name="observations" rows="4" placeholder="Ex: Sem cebola, ponto da carne mal passado, etc." class="form-textarea"></textarea>
                            <small class="form-hint">
                                <i class="fa fa-info-circle"></i> Use este campo para fazer solicitações especiais.
                            </small>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="fa fa-check"></i> FINALIZAR COMPRA
                    </button>
                </form>
                
                <a href="{{ url_for('main.index') }}" class="continue-shopping-link">
                    <i class="fa fa-arrow-left"></i> Continuar Comprando
                </a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <i class="fa fa-shopping-cart empty-cart__icon"></i>
        <h3 class="empty-cart__title">Seu carrinho está vazio</h3>
        <p class="empty-cart__description">Adicione produtos ao carrinho para continuar comprando</p>
        <a href="{{ url_for('main.index') }}" class="btn-primary" style="text-decoration: none;">
            <i class="fa fa-shopping-bag"></i> IR ÀS COMPRAS
        </a>
    </div>
    {% endif %}
</div>

<script>
    function toggleDeliveryFields() {
        const deliveryType = document.querySelector('input[name="delivery_type"]:checked');
        const deliveryAddressField = document.getElementById('delivery_address_field');

        if (deliveryAddressField && deliveryType) {
            const deliveryAddressInput = deliveryAddressField.querySelector('textarea');

            if (deliveryType.value === 'delivery') {
                deliveryAddressField.style.display = 'block';
                if (deliveryAddressInput) {
                    deliveryAddressInput.required = true;
                }
            } else {
                deliveryAddressField.style.display = 'none';
                if (deliveryAddressInput) {
                    deliveryAddressInput.required = false;
                }
            }
        }

        const labels = document.querySelectorAll('.delivery-option');
        labels.forEach(label => {
            const radio = label.querySelector('input[type="radio"]');
            if (radio && radio.checked) {
                label.style.borderColor = 'var(--color-red)';
                label.style.background = '#fff5f5';
            } else {
                label.style.borderColor = '#e0e0e0';
                label.style.background = '#fff';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        toggleDeliveryFields();
    });
</script>
{% endblock %}
