{% extends "base.html" %}

{% block title %}Meu Carrinho - {{ store_settings.store_name }}{% endblock %}

{% block content %}
<div class="cart-container">
    <h1 class="cart-title">
        <i class="fa fa-shopping-cart"></i> Meu Carrinho
    </h1>

    {% if cart_items %}
    <div class="cart-items-wrapper">
        {% for item in cart_items %}
        <div class="cart-item">
            <div class="cart-item__image-wrapper">
                {% if item.product.image_url %}
                <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" class="cart-item__image">
                {% else %}
                <i class="fa fa-cutlery cart-item__image-placeholder"></i>
                {% endif %}
            </div>
            
            <div class="cart-item__details">
                <div class="cart-item__name">{{ item.product.name }}</div>
                <div class="cart-item__code">Cód: {{ item.product.code }}</div>
                
                {% if item.extras %}
                <div class="cart-item__extras">
                    <div class="cart-item__extras-title">
                        <i class="fa fa-plus-circle"></i> Adicionais:
                    </div>
                    {% for cart_extra in item.extras %}
                    <div class="cart-item__extra-item">
                        <span class="cart-item__extra-name">
                            <i class="fa fa-check" style="color: #28a745; font-size: 10px;"></i>
                            {{ cart_extra.quantity }}x {{ cart_extra.extra.name }}
                        </span>
                        <span class="cart-item__extra-price">
                            + R$ {{ "%.2f"|format(cart_extra.extra.price * cart_extra.quantity) }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if item.observations %}
                <div class="cart-item__observations">
                    <div class="cart-item__observations-title">
                        <i class="fa fa-comment"></i> Observações:
                    </div>
                    <div class="cart-item__observations-text">
                        {{ item.observations }}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="cart-item__price" data-label="Preço">
                <div class="cart-item__price-main">
                    R$ {{ "%.2f"|format(item.product.price) }}
                </div>
                {% if item.extras %}
                {% set extras_total = namespace(value=0) %}
                {% for extra in item.extras %}
                    {% set extras_total.value = extras_total.value + (extra.extra.price * extra.quantity) %}
                {% endfor %}
                <div class="cart-item__price-extras">
                    + R$ {{ "%.2f"|format(extras_total.value) }}
                </div>
                {% endif %}
            </div>
            
            <div class="cart-item__quantity" data-label="Quantidade">
                {{ item.quantity }}
            </div>
            
            <div class="cart-item__subtotal" data-label="Subtotal">
                {% set item_extras_total = namespace(value=0) %}
                {% for extra in item.extras %}
                    {% set item_extras_total.value = item_extras_total.value + (extra.extra.price * extra.quantity) %}
                {% endfor %}
                <div class="cart-item__subtotal-amount">
                    R$ {{ "%.2f"|format((item.product.price + item_extras_total.value) * item.quantity) }}
                </div>
            </div>
            
            <div class="cart-item__actions">
                <a href="{{ url_for('cart.remove_from_cart', item_id=item.id) }}" class="btn-outline-danger">
                    <i class="fa fa-trash"></i> Remover
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="summary-box">
        <div class="summary-box__inner">
            <div class="cart-summary">
                <h2 class="cart-summary__title">Resumo do Pedido</h2>
                
                <div class="cart-summary__row">
                    <span class="cart-summary__label">Subtotal:</span>
                    <span class="cart-summary__value">R$ {{ "%.2f"|format(subtotal) }}</span>
                </div>
                
                {% if coupon %}
                <div class="cart-summary__row">
                    <span class="cart-summary__label">Desconto ({{ coupon.code }}):</span>
                    <span class="cart-summary__value" style="color: var(--color-green);">
                        - R$ {{ "%.2f"|format(discount) }}
                    </span>
                </div>
                {% endif %}
                
                <div class="cart-summary__row cart-summary__total">
                    <span class="cart-summary__label">TOTAL:</span>
                    <span class="cart-summary__value">R$ {{ "%.2f"|format(total) }}</span>
                </div>
                
                <div class="pix-discount-banner">
                    <i class="fa fa-money"></i>
                    <strong>R$ {{ "%.2f"|format(total * 0.95) }}</strong> no PIX (5% de desconto)
                </div>

                <form method="POST" action="{{ url_for('cart.checkout') }}" id="checkoutForm">
                    <div class="form-section">
                        <h3 class="form-section__title">
                            <i class="fa fa-truck" style="color: var(--color-red);"></i> Tipo de Entrega
                        </h3>

                        {% if pickup_enabled %}
                        <label class="delivery-option">
                            <input type="radio" name="delivery_type" value="pickup" onchange="toggleDeliveryFields()" required>
                            <div class="delivery-option__content">
                                <strong class="delivery-option__title">
                                    <i class="fa fa-map-marker" style="color: var(--color-red);"></i>
                                    Retirada no Local
                                </strong>
                                <div class="delivery-option__description">
                                    {{ pickup_address }}
                                </div>
                                <span class="badge badge-success">
                                    <i class="fa fa-check-circle"></i> Sem custo de frete
                                </span>
                            </div>
                        </label>
                        {% endif %}

                        {% if delivery_enabled %}
                        <label class="delivery-option">
                            <input type="radio" name="delivery_type" value="delivery" {% if not pickup_enabled %}checked{% endif %} onchange="toggleDeliveryFields()" required>
                            <div class="delivery-option__content">
                                <strong class="delivery-option__title">
                                    <i class="fa fa-truck" style="color: var(--color-red);"></i>
                                    Entrega em Domicílio
                                </strong>
                                <div class="delivery-option__description">
                                    {% if total >= free_shipping_min %}
                                    <span class="badge badge-success">
                                        <i class="fa fa-check-circle"></i> FRETE GRÁTIS!
                                    </span>
                                    {% else %}
                                    Valor do frete: <strong>R$ {{ "%.2f"|format(shipping_cost) }}</strong>
                                    <div class="text-muted">
                                        <i class="fa fa-info-circle"></i> Frete grátis acima de R$ {{ "%.2f"|format(free_shipping_min) }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </label>
                        {% endif %}
                    </div>

                    <div class="form-section">
                        <h3 class="form-section__title">
                            <i class="fa fa-user" style="color: var(--color-red);"></i> Dados para Entrega
                        </h3>

                        <div id="delivery_address_field" class="form-group" style="display: none;">
                            {% if delivery_radius_enabled %}
                            <div style="margin-bottom: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                                <div style="display: flex; align-items: flex-start; gap: 8px;">
                                    <i class="fa fa-info-circle" style="color: #856404; margin-top: 2px;"></i>
                                    <div style="font-size: 13px; color: #856404; line-height: 1.5;">
                                        <strong>Área de Cobertura:</strong> Realizamos entregas em um raio de até <strong>{{ delivery_radius_km }} km</strong> a partir da nossa localização. Digite o CEP e o número para validarmos automaticamente.
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div style="margin-bottom: 15px;">
                                <label class="form-label">
                                    <i class="fa fa-map-pin"></i> CEP *
                                </label>
                                <div style="display: flex; gap: 10px;">
                                    <input 
                                        type="text" 
                                        id="customer_cep" 
                                        name="customer_cep" 
                                        class="form-textarea" 
                                        placeholder="00000-000"
                                        maxlength="9"
                                        style="padding: 12px; height: auto; flex: 1;"
                                    >
                                    <button 
                                        type="button" 
                                        id="toggleSearchMode" 
                                        onclick="toggleCEPSearchMode()"
                                        style="padding: 12px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 13px;"
                                        title="Não sabe o CEP? Clique para buscar pelo endereço"
                                    >
                                        <i class="fa fa-search"></i> Buscar CEP
                                    </button>
                                </div>
                                <small style="display: block; margin-top: 5px; color: #666; font-size: 12px;">
                                    <i class="fa fa-info-circle"></i> O endereço será preenchido automaticamente. Não sabe o CEP? Clique em "Buscar CEP"
                                </small>
                            </div>

                            <div id="reverseCEPSearch" style="display: none; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #6c757d;">
                                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">
                                    <i class="fa fa-search"></i> Buscar CEP pelo Endereço
                                </h4>
                                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px;">
                                    <div>
                                        <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 5px;">Estado (UF)</label>
                                        <input 
                                            type="text" 
                                            id="search_state" 
                                            placeholder="Ex: MG"
                                            maxlength="2"
                                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-transform: uppercase;"
                                        >
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 5px;">Cidade</label>
                                        <input 
                                            type="text" 
                                            id="search_city" 
                                            placeholder="Ex: Contagem"
                                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                        >
                                    </div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 5px;">Rua/Avenida</label>
                                    <input 
                                        type="text" 
                                        id="search_street" 
                                        placeholder="Ex: Rua Judith Naves de Lima (mínimo 3 caracteres)"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    >
                                </div>
                                <button 
                                    type="button" 
                                    onclick="searchCEPByAddress()"
                                    style="width: 100%; padding: 10px; background: var(--color-red); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;"
                                >
                                    <i class="fa fa-search"></i> Buscar CEP
                                </button>
                                <div id="searchResults" style="margin-top: 10px; display: none;">
                                    <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 5px;">Resultados Encontrados:</label>
                                    <div id="searchResultsList" style="max-height: 200px; overflow-y: auto;"></div>
                                </div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label class="form-label">
                                    <i class="fa fa-road"></i> Rua/Avenida *
                                </label>
                                <input 
                                    type="text" 
                                    id="customer_street" 
                                    name="customer_street" 
                                    class="form-textarea" 
                                    placeholder="Ex: Rua Judith Naves de Lima"
                                    readonly
                                    style="padding: 12px; height: auto; background-color: #f5f5f5;"
                                >
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label">
                                        <i class="fa fa-hashtag"></i> Número *
                                    </label>
                                    <input 
                                        type="text" 
                                        id="customer_number" 
                                        name="customer_number" 
                                        class="form-textarea" 
                                        placeholder="Ex: 469"
                                        style="padding: 12px; height: auto;"
                                    >
                                </div>
                                <div>
                                    <label class="form-label">
                                        <i class="fa fa-building"></i> Complemento (Opcional)
                                    </label>
                                    <input 
                                        type="text" 
                                        id="customer_complement" 
                                        name="customer_complement" 
                                        class="form-textarea" 
                                        placeholder="Ex: Apto 201, Bloco A"
                                        style="padding: 12px; height: auto;"
                                    >
                                </div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label class="form-label">
                                    <i class="fa fa-map"></i> Bairro *
                                </label>
                                <input 
                                    type="text" 
                                    id="customer_neighborhood" 
                                    name="customer_neighborhood" 
                                    class="form-textarea" 
                                    placeholder="Ex: Santa Edwiges"
                                    readonly
                                    style="padding: 12px; height: auto; background-color: #f5f5f5;"
                                >
                            </div>

                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label">
                                        <i class="fa fa-building"></i> Cidade *
                                    </label>
                                    <input 
                                        type="text" 
                                        id="customer_city" 
                                        name="customer_city" 
                                        class="form-textarea" 
                                        placeholder="Ex: Contagem"
                                        readonly
                                        style="padding: 12px; height: auto; background-color: #f5f5f5;"
                                    >
                                </div>
                                <div>
                                    <label class="form-label">
                                        <i class="fa fa-flag"></i> Estado *
                                    </label>
                                    <input 
                                        type="text" 
                                        id="customer_state" 
                                        name="customer_state" 
                                        class="form-textarea" 
                                        placeholder="Ex: MG"
                                        readonly
                                        style="padding: 12px; height: auto; background-color: #f5f5f5;"
                                    >
                                </div>
                            </div>

                            <input type="hidden" id="delivery_address_hidden" name="delivery_address">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-comment"></i> Observações (Opcional)
                            </label>
                            <textarea name="observations" rows="4" placeholder="Ex: Sem cebola, ponto da carne mal passado, etc." class="form-textarea"></textarea>
                            <small class="form-hint">
                                <i class="fa fa-info-circle"></i> Use este campo para fazer solicitações especiais.
                            </small>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="fa fa-check"></i> FINALIZAR COMPRA
                    </button>
                </form>
                
                <a href="{{ url_for('main.index') }}" class="continue-shopping-link">
                    <i class="fa fa-arrow-left"></i> Continuar Comprando
                </a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <i class="fa fa-shopping-cart empty-cart__icon"></i>
        <h3 class="empty-cart__title">Seu carrinho está vazio</h3>
        <p class="empty-cart__description">Adicione produtos ao carrinho para continuar comprando</p>
        <a href="{{ url_for('main.index') }}" class="btn-primary" style="text-decoration: none;">
            <i class="fa fa-shopping-bag"></i> IR ÀS COMPRAS
        </a>
    </div>
    {% endif %}
</div>

<style>
.cart-item__observations {
    margin-top: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-left: 3px solid #17a2b8;
    border-radius: 4px;
}

.cart-item__observations-title {
    font-size: 13px;
    font-weight: 700;
    color: #17a2b8;
    margin-bottom: 6px;
}

.cart-item__observations-text {
    font-size: 13px;
    color: #495057;
    line-height: 1.6;
    font-style: italic;
}
</style>

<script>
    function toggleDeliveryFields() {
        const deliveryType = document.querySelector('input[name="delivery_type"]:checked');
        const deliveryAddressField = document.getElementById('delivery_address_field');

        if (deliveryAddressField && deliveryType) {
            const cepInput = document.getElementById('customer_cep');
            const streetInput = document.getElementById('customer_street');
            const numberInput = document.getElementById('customer_number');
            const neighborhoodInput = document.getElementById('customer_neighborhood');
            const cityInput = document.getElementById('customer_city');
            const stateInput = document.getElementById('customer_state');

            if (deliveryType.value === 'delivery') {
                deliveryAddressField.style.display = 'block';
                if (cepInput) cepInput.required = true;
                if (streetInput) streetInput.required = true;
                if (numberInput) numberInput.required = true;
                if (neighborhoodInput) neighborhoodInput.required = true;
                if (cityInput) cityInput.required = true;
                if (stateInput) stateInput.required = true;
            } else {
                deliveryAddressField.style.display = 'none';
                if (cepInput) cepInput.required = false;
                if (streetInput) streetInput.required = false;
                if (numberInput) numberInput.required = false;
                if (neighborhoodInput) neighborhoodInput.required = false;
                if (cityInput) cityInput.required = false;
                if (stateInput) stateInput.required = false;
            }
        }

        const labels = document.querySelectorAll('.delivery-option');
        labels.forEach(label => {
            const radio = label.querySelector('input[type="radio"]');
            if (radio && radio.checked) {
                label.style.borderColor = 'var(--color-red)';
                label.style.background = '#fff5f5';
            } else {
                label.style.borderColor = '#e0e0e0';
                label.style.background = '#fff';
            }
        });
    }

    function formatCEP(value) {
        value = value.replace(/\D/g, '');
        if (value.length > 5) {
            value = value.substring(0, 5) + '-' + value.substring(5, 8);
        }
        return value;
    }

    function toggleCEPSearchMode() {
        const reverseSearch = document.getElementById('reverseCEPSearch');
        const toggleBtn = document.getElementById('toggleSearchMode');
        
        if (reverseSearch.style.display === 'none') {
            reverseSearch.style.display = 'block';
            toggleBtn.innerHTML = '<i class="fa fa-times"></i> Fechar Busca';
            toggleBtn.style.background = '#dc3545';
        } else {
            reverseSearch.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fa fa-search"></i> Buscar CEP';
            toggleBtn.style.background = '#6c757d';
            document.getElementById('searchResults').style.display = 'none';
        }
    }

    function searchCEPByAddress() {
        const estado = document.getElementById('search_state').value.trim().toUpperCase();
        const cidade = document.getElementById('search_city').value.trim();
        const logradouro = document.getElementById('search_street').value.trim();

        if (!estado || !cidade || !logradouro) {
            alert('Por favor, preencha Estado, Cidade e Rua/Avenida');
            return;
        }

        if (logradouro.length < 3) {
            alert('O nome da rua deve ter no mínimo 3 caracteres');
            return;
        }

        const searchResults = document.getElementById('searchResults');
        const searchResultsList = document.getElementById('searchResultsList');
        
        searchResultsList.innerHTML = '<div style="text-align: center; padding: 10px;"><i class="fa fa-spinner fa-spin"></i> Buscando...</div>';
        searchResults.style.display = 'block';

        fetch('/api/cep/buscar-endereco', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                estado: estado,
                cidade: cidade,
                logradouro: logradouro
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data && data.data.length > 0) {
                let html = '';
                data.data.forEach((item, index) => {
                    html += `
                        <div style="padding: 10px; margin-bottom: 5px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" 
                             onclick="selectCEP('${item.cep}', '${item.logradouro}', '${item.bairro}', '${item.localidade}', '${item.uf}')">
                            <div style="font-weight: 600; color: var(--color-red);">CEP: ${item.cep}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${item.logradouro}${item.complemento ? ' - ' + item.complemento : ''}<br>
                                ${item.bairro} - ${item.localidade}/${item.uf}
                            </div>
                        </div>
                    `;
                });
                searchResultsList.innerHTML = html;
            } else {
                searchResultsList.innerHTML = `
                    <div style="padding: 10px; text-align: center; color: #dc3545;">
                        <i class="fa fa-exclamation-triangle"></i> Nenhum CEP encontrado. Tente refinar sua busca.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Erro ao buscar CEP:', error);
            searchResultsList.innerHTML = `
                <div style="padding: 10px; text-align: center; color: #dc3545;">
                    <i class="fa fa-times-circle"></i> Erro ao buscar. Tente novamente.
                </div>
            `;
        });
    }

    function selectCEP(cep, street, neighborhood, city, state) {
        document.getElementById('customer_cep').value = cep;
        document.getElementById('customer_street').value = street;
        document.getElementById('customer_neighborhood').value = neighborhood;
        document.getElementById('customer_city').value = city;
        document.getElementById('customer_state').value = state;
        
        const streetInput = document.getElementById('customer_street');
        const neighborhoodInput = document.getElementById('customer_neighborhood');
        const cityInput = document.getElementById('customer_city');
        const stateInput = document.getElementById('customer_state');
        
        streetInput.removeAttribute('readonly');
        neighborhoodInput.removeAttribute('readonly');
        cityInput.removeAttribute('readonly');
        stateInput.removeAttribute('readonly');
        
        [streetInput, neighborhoodInput, cityInput, stateInput].forEach(input => {
            input.style.backgroundColor = '#d4edda';
        });
        
        setTimeout(() => {
            [streetInput, neighborhoodInput, cityInput, stateInput].forEach(input => {
                input.style.backgroundColor = '#f5f5f5';
            });
        }, 2000);
        
        toggleCEPSearchMode();
        document.getElementById('customer_number').focus();
        updateDeliveryAddress();
    }

    function updateDeliveryAddress() {
        const street = document.getElementById('customer_street').value;
        const number = document.getElementById('customer_number').value;
        const complement = document.getElementById('customer_complement').value;
        const neighborhood = document.getElementById('customer_neighborhood').value;
        const city = document.getElementById('customer_city').value;
        const state = document.getElementById('customer_state').value;
        const cep = document.getElementById('customer_cep').value;

        let fullAddress = '';
        if (street) fullAddress += street;
        if (number) fullAddress += ', ' + number;
        if (complement) fullAddress += ', ' + complement;
        if (neighborhood) fullAddress += ' - ' + neighborhood;
        if (city) fullAddress += ', ' + city;
        if (state) fullAddress += ' - ' + state;
        if (cep) fullAddress += ', CEP ' + cep;

        document.getElementById('delivery_address_hidden').value = fullAddress;
    }

    document.addEventListener('DOMContentLoaded', function () {
        toggleDeliveryFields();

        const cepInput = document.getElementById('customer_cep');
        const streetInput = document.getElementById('customer_street');
        const neighborhoodInput = document.getElementById('customer_neighborhood');
        const cityInput = document.getElementById('customer_city');
        const stateInput = document.getElementById('customer_state');
        const numberInput = document.getElementById('customer_number');
        const complementInput = document.getElementById('customer_complement');

        if (cepInput) {
            cepInput.addEventListener('input', function(e) {
                e.target.value = formatCEP(e.target.value);
            });

            cepInput.addEventListener('blur', function() {
                const cep = this.value.replace(/\D/g, '');
                
                if (cep.length === 8) {
                    fetch(`https://viacep.com.br/ws/${cep}/json/`)
                        .then(response => response.json())
                        .then(data => {
                            if (!data.erro) {
                                streetInput.value = data.logradouro;
                                neighborhoodInput.value = data.bairro;
                                cityInput.value = data.localidade;
                                stateInput.value = data.uf;
                                
                                streetInput.removeAttribute('readonly');
                                neighborhoodInput.removeAttribute('readonly');
                                cityInput.removeAttribute('readonly');
                                stateInput.removeAttribute('readonly');
                                
                                streetInput.style.backgroundColor = '#d4edda';
                                neighborhoodInput.style.backgroundColor = '#d4edda';
                                cityInput.style.backgroundColor = '#d4edda';
                                stateInput.style.backgroundColor = '#d4edda';
                                
                                setTimeout(() => {
                                    streetInput.style.backgroundColor = '#f5f5f5';
                                    neighborhoodInput.style.backgroundColor = '#f5f5f5';
                                    cityInput.style.backgroundColor = '#f5f5f5';
                                    stateInput.style.backgroundColor = '#f5f5f5';
                                }, 2000);

                                numberInput.focus();
                                updateDeliveryAddress();
                            } else {
                                streetInput.value = '';
                                neighborhoodInput.value = '';
                                cityInput.value = '';
                                stateInput.value = '';
                                
                                streetInput.removeAttribute('readonly');
                                neighborhoodInput.removeAttribute('readonly');
                                cityInput.removeAttribute('readonly');
                                stateInput.removeAttribute('readonly');
                                
                                streetInput.style.backgroundColor = '#fff';
                                neighborhoodInput.style.backgroundColor = '#fff';
                                cityInput.style.backgroundColor = '#fff';
                                stateInput.style.backgroundColor = '#fff';
                                
                                alert('CEP não encontrado. Por favor, preencha o endereço manualmente.');
                                streetInput.focus();
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao buscar CEP:', error);
                            
                            streetInput.value = '';
                            neighborhoodInput.value = '';
                            cityInput.value = '';
                            stateInput.value = '';
                            
                            streetInput.removeAttribute('readonly');
                            neighborhoodInput.removeAttribute('readonly');
                            cityInput.removeAttribute('readonly');
                            stateInput.removeAttribute('readonly');
                            
                            streetInput.style.backgroundColor = '#fff';
                            neighborhoodInput.style.backgroundColor = '#fff';
                            cityInput.style.backgroundColor = '#fff';
                            stateInput.style.backgroundColor = '#fff';
                            
                            alert('Erro ao buscar o CEP. Por favor, preencha o endereço manualmente.');
                            streetInput.focus();
                        });
                }
            });
        }

        [streetInput, numberInput, complementInput, neighborhoodInput, cityInput, stateInput].forEach(input => {
            if (input) {
                input.addEventListener('blur', updateDeliveryAddress);
                input.addEventListener('input', updateDeliveryAddress);
            }
        });

        const checkoutForm = document.querySelector('form');
        if (checkoutForm) {
            checkoutForm.addEventListener('submit', function(e) {
                const deliveryType = document.querySelector('input[name="delivery_type"]:checked');
                if (deliveryType && deliveryType.value === 'delivery') {
                    updateDeliveryAddress();
                    
                    const deliveryAddressValue = document.getElementById('delivery_address_hidden').value;
                    if (!deliveryAddressValue || deliveryAddressValue.trim() === '') {
                        e.preventDefault();
                        alert('Por favor, preencha todos os campos obrigatórios do endereço de entrega.');
                        cepInput.focus();
                        return false;
                    }
                    
                    const requiredFields = [cepInput, streetInput, numberInput, neighborhoodInput, cityInput, stateInput];
                    for (let field of requiredFields) {
                        if (!field.value || field.value.trim() === '') {
                            e.preventDefault();
                            alert('Por favor, preencha todos os campos obrigatórios do endereço de entrega.');
                            field.focus();
                            return false;
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}
