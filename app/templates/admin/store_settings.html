{% extends "base.html" %}

{% block title %}Configurações da Loja - Admin - {{ store_settings.store_name }}{% endblock %}

{% block content %}
<div class="admin_container">
    <div class="admin_header">
        <h1><i class="fa fa-cog"></i> Configurações da Loja</h1>
        <a href="{{ url_for('admin.dashboard') }}" class="btn_secondary">
            <i class="fa fa-arrow-left"></i> Voltar ao Dashboard
        </a>
    </div>

    <div class="admin_content">
        <form method="POST" class="admin_form">
            <div class="form_section">
                <h2><i class="fa fa-building"></i> Informações da Loja</h2>
                
                <div class="form_group">
                    <label for="store_name">
                        <i class="fa fa-store"></i> Nome da Loja
                    </label>
                    <input 
                        type="text" 
                        id="store_name" 
                        name="store_name" 
                        class="form_control" 
                        value="{{ settings.store_name }}"
                        required
                    >
                    <small class="form_text">Nome que aparecerá no topo do site</small>
                </div>

                <div class="form_group">
                    <label for="store_logo">
                        <i class="fa fa-image"></i> URL do Logo
                    </label>
                    <input 
                        type="url" 
                        id="store_logo" 
                        name="store_logo" 
                        class="form_control" 
                        value="{{ settings.store_logo }}"
                        placeholder="https://exemplo.com/logo.png"
                    >
                    <small class="form_text">URL do logotipo da sua loja (deixe em branco para usar apenas texto)</small>
                </div>

                <div class="form_group">
                    <label for="store_description">
                        <i class="fa fa-info-circle"></i> Descrição da Loja
                    </label>
                    <textarea 
                        id="store_description" 
                        name="store_description" 
                        rows="2" 
                        class="form_control"
                        placeholder="Slogan ou descrição curta da sua loja"
                    >{{ settings.store_description }}</textarea>
                    <small class="form_text">Descrição que aparece no site</small>
                </div>
            </div>

            <div class="form_section">
                <h2><i class="fa fa-phone"></i> Informações de Contato</h2>
                
                <div class="form_group">
                    <label for="store_phone">
                        <i class="fa fa-phone"></i> Telefone
                    </label>
                    <input 
                        type="text" 
                        id="store_phone" 
                        name="store_phone" 
                        class="form_control" 
                        value="{{ settings.store_phone }}"
                        placeholder="(31) 98765-4321"
                    >
                    <small class="form_text">Telefone de contato com DDD</small>
                </div>

                <div class="form_group">
                    <label for="store_whatsapp">
                        <i class="fa fa-whatsapp"></i> WhatsApp (Número completo)
                    </label>
                    <input 
                        type="text" 
                        id="store_whatsapp" 
                        name="store_whatsapp" 
                        class="form_control" 
                        value="{{ settings.store_whatsapp }}"
                        placeholder="5531987654321"
                    >
                    <small class="form_text">Número do WhatsApp com código do país (Ex: 5531987654321)</small>
                </div>

                <div class="form_group">
                    <label for="store_email">
                        <i class="fa fa-envelope"></i> E-mail
                    </label>
                    <input 
                        type="email" 
                        id="store_email" 
                        name="store_email" 
                        class="form_control" 
                        value="{{ settings.store_email }}"
                        placeholder="contato@tcb.com.br"
                    >
                    <small class="form_text">E-mail de contato</small>
                </div>
            </div>

            <div class="form_section">
                <h2><i class="fa fa-store"></i> Retirada no Local</h2>
                
                <div class="form_group checkbox_group">
                    <label class="checkbox_label">
                        <input type="checkbox" name="pickup_enabled" {% if settings.pickup_enabled %}checked{% endif %}>
                        <span>Habilitar retirada no local</span>
                    </label>
                </div>

                <div class="form_group">
                    <label for="pickup_address">
                        <i class="fa fa-map-marker"></i> Endereço para Retirada
                    </label>
                    <textarea 
                        id="pickup_address" 
                        name="pickup_address" 
                        rows="3" 
                        class="form_control"
                        placeholder="Av. Exemplo, 123 - Centro - São Paulo, SP - CEP 01000-000"
                    >{{ settings.pickup_address }}</textarea>
                    <small class="form_text">Este endereço será exibido para os clientes que escolherem retirada no local</small>
                </div>
            </div>

            <div class="form_section">
                <h2><i class="fa fa-truck"></i> Entrega</h2>
                
                <div class="form_group checkbox_group">
                    <label class="checkbox_label">
                        <input type="checkbox" name="delivery_enabled" {% if settings.delivery_enabled %}checked{% endif %}>
                        <span>Habilitar entrega</span>
                    </label>
                </div>

                <div class="form_group">
                    <label for="shipping_cost">
                        <i class="fa fa-dollar"></i> Custo de Entrega (R$)
                    </label>
                    <input 
                        type="number" 
                        id="shipping_cost" 
                        name="shipping_cost" 
                        class="form_control" 
                        step="0.01" 
                        min="0"
                        value="{{ settings.shipping_cost }}"
                        required
                    >
                    <small class="form_text">Valor fixo de entrega</small>
                </div>

                <div class="form_group">
                    <label for="free_shipping_min">
                        <i class="fa fa-gift"></i> Compra Mínima para Frete Grátis (R$)
                    </label>
                    <input 
                        type="number" 
                        id="free_shipping_min" 
                        name="free_shipping_min" 
                        class="form_control" 
                        step="0.01" 
                        min="0"
                        value="{{ settings.free_shipping_min }}"
                        required
                    >
                    <small class="form_text">Valor mínimo de compra para frete grátis</small>
                </div>
            </div>

            <div class="form_section">
                <h2><i class="fa fa-map-marker"></i> Área de Cobertura de Entrega</h2>
                
                <div class="form_group checkbox_group">
                    <label class="checkbox_label">
                        <input type="checkbox" name="delivery_radius_enabled" {% if settings.delivery_radius_enabled %}checked{% endif %}>
                        <span>Habilitar validação por raio de entrega</span>
                    </label>
                    <small class="form_text">Quando habilitado, o sistema validará se o endereço do cliente está dentro do raio de entrega</small>
                </div>

                <div class="form_group">
                    <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; margin-bottom: 20px;">
                        <strong><i class="fa fa-info-circle"></i> Como funciona?</strong>
                        <p style="margin: 10px 0 0 0; font-size: 13px; line-height: 1.6;">
                            Digite o CEP da hamburgueria e o sistema buscará automaticamente o endereço. Depois, complete com o número. As coordenadas geográficas serão calculadas automaticamente.
                        </p>
                    </div>
                </div>

                <div class="form_group">
                    <label for="store_cep">
                        <i class="fa fa-map-pin"></i> CEP da Loja
                    </label>
                    <input 
                        type="text" 
                        id="store_cep" 
                        name="store_cep" 
                        class="form_control" 
                        value="{{ settings.store_cep }}"
                        placeholder="00000-000"
                        maxlength="9"
                    >
                    <small class="form_text">Digite o CEP e aguarde o carregamento automático do endereço</small>
                </div>

                <div class="form_group">
                    <label for="store_street">
                        <i class="fa fa-road"></i> Rua/Avenida
                    </label>
                    <input 
                        type="text" 
                        id="store_street" 
                        name="store_street" 
                        class="form_control" 
                        value="{{ settings.store_street }}"
                        placeholder="Ex: Rua Judith Naves de Lima"
                        readonly
                    >
                    <small class="form_text">Preenchido automaticamente pelo CEP</small>
                </div>

                <div class="form_group">
                    <label for="store_number">
                        <i class="fa fa-hashtag"></i> Número
                    </label>
                    <input 
                        type="text" 
                        id="store_number" 
                        name="store_number" 
                        class="form_control" 
                        value="{{ settings.store_number }}"
                        placeholder="Ex: 469"
                    >
                    <small class="form_text">Número do estabelecimento</small>
                </div>

                <div class="form_group">
                    <label for="store_neighborhood">
                        <i class="fa fa-map"></i> Bairro
                    </label>
                    <input 
                        type="text" 
                        id="store_neighborhood" 
                        name="store_neighborhood" 
                        class="form_control" 
                        value="{{ settings.store_neighborhood }}"
                        placeholder="Ex: Santa Edwiges"
                        readonly
                    >
                    <small class="form_text">Preenchido automaticamente pelo CEP</small>
                </div>

                <div class="form_group">
                    <label for="store_city">
                        <i class="fa fa-building"></i> Cidade
                    </label>
                    <input 
                        type="text" 
                        id="store_city" 
                        name="store_city" 
                        class="form_control" 
                        value="{{ settings.store_city }}"
                        placeholder="Ex: Contagem"
                        readonly
                    >
                    <small class="form_text">Preenchido automaticamente pelo CEP</small>
                </div>

                <div class="form_group">
                    <label for="store_state">
                        <i class="fa fa-flag"></i> Estado
                    </label>
                    <input 
                        type="text" 
                        id="store_state" 
                        name="store_state" 
                        class="form_control" 
                        value="{{ settings.store_state }}"
                        placeholder="Ex: MG"
                        readonly
                    >
                    <small class="form_text">Preenchido automaticamente pelo CEP</small>
                </div>

                <div class="form_group">
                    <label for="delivery_radius_km">
                        <i class="fa fa-circle-o"></i> Raio de Entrega (km)
                    </label>
                    <input 
                        type="number" 
                        id="delivery_radius_km" 
                        name="delivery_radius_km" 
                        class="form_control" 
                        step="0.1" 
                        min="0"
                        value="{{ settings.delivery_radius_km }}"
                        placeholder="10"
                    >
                    <small class="form_text">Raio máximo de entrega em quilômetros a partir da localização da loja</small>
                </div>

                <div class="form_group" style="display: none;">
                    <label for="store_latitude">
                        <i class="fa fa-globe"></i> Latitude (Auto)
                    </label>
                    <input 
                        type="text" 
                        id="store_latitude" 
                        name="store_latitude" 
                        class="form_control" 
                        value="{{ settings.store_latitude }}"
                        readonly
                    >
                </div>

                <div class="form_group" style="display: none;">
                    <label for="store_longitude">
                        <i class="fa fa-globe"></i> Longitude (Auto)
                    </label>
                    <input 
                        type="text" 
                        id="store_longitude" 
                        name="store_longitude" 
                        class="form_control" 
                        value="{{ settings.store_longitude }}"
                        readonly
                    >
                </div>

                <div id="coordinates_status" style="padding: 10px; background: #e9ecef; border-radius: 4px; margin-top: 10px; display: none;">
                    <small>
                        <i class="fa fa-map-marker"></i> <strong>Coordenadas:</strong> 
                        <span id="coords_display">Aguardando endereço...</span>
                    </small>
                </div>
            </div>

            <div class="form_section">
                <h2><i class="fa fa-clock"></i> Horários de Funcionamento</h2>
                
                <div class="form_group">
                    <label for="opening_hours_monday">
                        <i class="fa fa-calendar"></i> Segunda-feira
                    </label>
                    <input 
                        type="text" 
                        id="opening_hours_monday" 
                        name="opening_hours_monday" 
                        class="form_control" 
                        value="{{ settings.opening_hours_monday }}"
                        placeholder="18:00 - 23:59 ou Fechado"
                    >
                </div>

                <div class="form_group">
                    <label for="opening_hours_tuesday">
                        <i class="fa fa-calendar"></i> Terça-feira
                    </label>
                    <input 
                        type="text" 
                        id="opening_hours_tuesday" 
                        name="opening_hours_tuesday" 
                        class="form_control" 
                        value="{{ settings.opening_hours_tuesday }}"
                        placeholder="18:00 - 23:59 ou Fechado"
                    >
                </div>

                <div class="form_group">
                    <label for="opening_hours_wednesday">
                        <i class="fa fa-calendar"></i> Quarta-feira
                    </label>
                    <input 
                        type="text" 
                        id="opening_hours_wednesday" 
                        name="opening_hours_wednesday" 
                        class="form_control" 
                        value="{{ settings.opening_hours_wednesday }}"
                        placeholder="18:00 - 23:59 ou Fechado"
                    >
                </div>

                <div class="form_group">
                    <label for="opening_hours_thursday">
                        <i class="fa fa-calendar"></i> Quinta-feira
                    </label>
                    <input 
                        type="text" 
                        id="opening_hours_thursday" 
                        name="opening_hours_thursday" 
                        class="form_control" 
                        value="{{ settings.opening_hours_thursday }}"
                        placeholder="18:00 - 23:59 ou Fechado"
                    >
                </div>

                <div class="form_group">
                    <label for="opening_hours_friday">
                        <i class="fa fa-calendar"></i> Sexta-feira
                    </label>
                    <input 
                        type="text" 
                        id="opening_hours_friday" 
                        name="opening_hours_friday" 
                        class="form_control" 
                        value="{{ settings.opening_hours_friday }}"
                        placeholder="18:00 - 23:59 ou Fechado"
                    >
                </div>

                <div class="form_group">
                    <label for="opening_hours_saturday">
                        <i class="fa fa-calendar"></i> Sábado
                    </label>
                    <input 
                        type="text" 
                        id="opening_hours_saturday" 
                        name="opening_hours_saturday" 
                        class="form_control" 
                        value="{{ settings.opening_hours_saturday }}"
                        placeholder="18:00 - 23:59 ou Fechado"
                    >
                </div>

                <div class="form_group">
                    <label for="opening_hours_sunday">
                        <i class="fa fa-calendar"></i> Domingo
                    </label>
                    <input 
                        type="text" 
                        id="opening_hours_sunday" 
                        name="opening_hours_sunday" 
                        class="form_control" 
                        value="{{ settings.opening_hours_sunday }}"
                        placeholder="18:00 - 23:59 ou Fechado"
                    >
                </div>
            </div>

            <div class="form_actions">
                <button type="submit" class="btn_primary">
                    <i class="fa fa-save"></i> Salvar Configurações
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.admin_container {
    max-width: 900px;
    margin: 30px auto;
    padding: 0 20px;
}

.admin_header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e0e0e0;
}

.admin_header h1 {
    font-size: 28px;
    color: #333;
}

.admin_content {
    background: #fff;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.form_section {
    margin-bottom: 35px;
    padding-bottom: 25px;
    border-bottom: 1px solid #e0e0e0;
}

.form_section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
}

.form_section h2 {
    font-size: 20px;
    color: #333;
    margin-bottom: 20px;
}

.form_group {
    margin-bottom: 20px;
}

.form_group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #555;
}

.form_control {
    width: 100%;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form_control:focus {
    outline: none;
    border-color: var(--color-red);
}

.form_text {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #999;
}

.checkbox_group {
    margin-bottom: 15px;
}

.checkbox_label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: normal;
}

.checkbox_label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 10px;
    cursor: pointer;
}

.checkbox_label span {
    font-size: 15px;
    color: #333;
}

.form_actions {
    margin-top: 30px;
    text-align: right;
}

.btn_primary {
    background: var(--color-red);
    color: #fff;
    border: none;
    padding: 12px 30px;
    border-radius: 5px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s;
}

.btn_primary:hover {
    background: var(--color-red-dark);
}

.btn_secondary {
    background: #6c757d;
    color: #fff;
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    transition: background 0.3s;
}

.btn_secondary:hover {
    background: #5a6268;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cepInput = document.getElementById('store_cep');
    const streetInput = document.getElementById('store_street');
    const neighborhoodInput = document.getElementById('store_neighborhood');
    const cityInput = document.getElementById('store_city');
    const stateInput = document.getElementById('store_state');
    const numberInput = document.getElementById('store_number');
    const latInput = document.getElementById('store_latitude');
    const lonInput = document.getElementById('store_longitude');
    const coordsStatus = document.getElementById('coordinates_status');
    const coordsDisplay = document.getElementById('coords_display');

    function formatCEP(value) {
        value = value.replace(/\D/g, '');
        if (value.length > 5) {
            value = value.substring(0, 5) + '-' + value.substring(5, 8);
        }
        return value;
    }

    cepInput.addEventListener('input', function(e) {
        e.target.value = formatCEP(e.target.value);
    });

    cepInput.addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        streetInput.value = data.logradouro;
                        neighborhoodInput.value = data.bairro;
                        cityInput.value = data.localidade;
                        stateInput.value = data.uf;
                        
                        streetInput.style.backgroundColor = '#d4edda';
                        neighborhoodInput.style.backgroundColor = '#d4edda';
                        cityInput.style.backgroundColor = '#d4edda';
                        stateInput.style.backgroundColor = '#d4edda';
                        
                        setTimeout(() => {
                            streetInput.style.backgroundColor = '';
                            neighborhoodInput.style.backgroundColor = '';
                            cityInput.style.backgroundColor = '';
                            stateInput.style.backgroundColor = '';
                        }, 2000);

                        updateCoordinates();
                    } else {
                        alert('CEP não encontrado. Por favor, verifique o CEP digitado.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar CEP:', error);
                    alert('Erro ao buscar o CEP. Tente novamente.');
                });
        }
    });

    numberInput.addEventListener('blur', updateCoordinates);

    function updateCoordinates() {
        const street = streetInput.value;
        const number = numberInput.value;
        const neighborhood = neighborhoodInput.value;
        const city = cityInput.value;
        const state = stateInput.value;

        if (street && number && city && state) {
            const fullAddress = `${street}, ${number} - ${neighborhood}, ${city} - ${state}, Brasil`;
            
            coordsStatus.style.display = 'block';
            coordsDisplay.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Buscando coordenadas...';

            fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(fullAddress)}&format=json&limit=1&countrycodes=br`, {
                headers: {
                    'User-Agent': 'SandwichGourmet/1.0 (E-commerce Platform)'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    
                    latInput.value = lat.toFixed(6);
                    lonInput.value = lon.toFixed(6);
                    
                    coordsDisplay.innerHTML = `<span style="color: #28a745;">✓ Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}</span>`;
                } else {
                    coordsDisplay.innerHTML = '<span style="color: #dc3545;">✗ Não foi possível obter as coordenadas. Verifique o endereço.</span>';
                }
            })
            .catch(error => {
                console.error('Erro ao buscar coordenadas:', error);
                coordsDisplay.innerHTML = '<span style="color: #dc3545;">✗ Erro ao buscar coordenadas.</span>';
            });
        }
    }
});
</script>
{% endblock %}
